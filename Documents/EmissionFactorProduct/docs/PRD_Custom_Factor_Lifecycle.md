# PRD: è‡ªå»ºä¿‚æ•¸ç”Ÿå‘½é€±æœŸç®¡ç†

## æ–‡æª”è³‡è¨Š
- **ç‰ˆæœ¬**: v1.0
- **å»ºç«‹æ—¥æœŸ**: 2025-11-10
- **è² è²¬äºº**: Product Team
- **ç‹€æ…‹**: Draft

## ç›®éŒ„
1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¥­å‹™ç›®æ¨™](#æ¥­å‹™ç›®æ¨™)
3. [ä½¿ç”¨è€…æ•…äº‹](#ä½¿ç”¨è€…æ•…äº‹)
4. [åŠŸèƒ½éœ€æ±‚](#åŠŸèƒ½éœ€æ±‚)
5. [ç‹€æ…‹ç®¡ç†](#ç‹€æ…‹ç®¡ç†)
6. [ä½¿ç”¨è€…æµç¨‹](#ä½¿ç”¨è€…æµç¨‹)
7. [UI/UX è¦æ ¼](#uiux-è¦æ ¼)
8. [æŠ€è¡“è¦æ ¼](#æŠ€è¡“è¦æ ¼)
9. [é©—æ”¶æ¨™æº–](#é©—æ”¶æ¨™æº–)
10. [é‚Šç•Œæƒ…æ³è™•ç†](#é‚Šç•Œæƒ…æ³è™•ç†)

---

## æ¦‚è¿°

æœ¬æ–‡æª”å®šç¾©è‡ªå»ºçµ„åˆä¿‚æ•¸å¾å»ºç«‹ã€åŒ¯å…¥ä¸­å¤®åº«ã€ç§»é™¤ã€åˆ°åˆªé™¤çš„å®Œæ•´ç”Ÿå‘½é€±æœŸç®¡ç†æµç¨‹ã€‚ç¢ºä¿ä½¿ç”¨è€…èƒ½å¤ æœ‰æ•ˆç®¡ç†è‡ªå»ºä¿‚æ•¸ï¼ŒåŒæ™‚ç¶­è­·è³‡æ–™çš„ä¸€è‡´æ€§å’Œå¯è¿½æº¯æ€§ã€‚

### æ ¸å¿ƒæµç¨‹
```
å»ºç«‹è‡ªå»ºä¿‚æ•¸ â†’ åŒ¯å…¥åˆ°ä¸­å¤®åº« â†’ å¾ä¸­å¤®åº«ç§»é™¤ â†’ åˆªé™¤è‡ªå»ºä¿‚æ•¸
     â†“              â†“              â†“              â†“
  ç‹€æ…‹è¿½è¹¤      ç‰ˆæœ¬åŒæ­¥      ç‹€æ…‹æ¢å¾©      å®Œå…¨åˆªé™¤
```

---

## æ¥­å‹™ç›®æ¨™

### ä¸»è¦ç›®æ¨™
1. **æä¾›å®Œæ•´çš„ä¿‚æ•¸ç”Ÿå‘½é€±æœŸç®¡ç†**
   - ä½¿ç”¨è€…å¯ä»¥å®Œå…¨æŒæ§è‡ªå»ºä¿‚æ•¸çš„æ•´å€‹ç”Ÿå‘½é€±æœŸ
   - å¾å»ºç«‹åˆ°åˆªé™¤çš„æ¯å€‹éšæ®µéƒ½æœ‰æ¸…æ™°çš„ç‹€æ…‹å’Œæ“ä½œ

2. **ç¢ºä¿è³‡æ–™ä¸€è‡´æ€§**
   - è‡ªå»ºä¿‚æ•¸èˆ‡ä¸­å¤®åº«ä¿‚æ•¸ä¹‹é–“çš„é—œè¯é—œä¿‚æ˜ç¢º
   - ç‹€æ…‹è®Šæ›´æ™‚è‡ªå‹•æ›´æ–°ç›¸é—œè¯çš„è³‡æ–™

3. **é˜²æ­¢èª¤åˆªèˆ‡è³‡æ–™éºå¤±**
   - æä¾›å¤šå±¤ç¢ºèªæ©Ÿåˆ¶
   - æ¸…æ¥šé¡¯ç¤ºåˆªé™¤å½±éŸ¿ç¯„åœ
   - ä¿ç•™å¿…è¦çš„å¯©è¨ˆè¨˜éŒ„

### æˆåŠŸæŒ‡æ¨™
- ä½¿ç”¨è€…èƒ½åœ¨ 3 æ­¥å…§å®Œæˆä»»ä½•ç”Ÿå‘½é€±æœŸæ“ä½œ
- é›¶å› ç‹€æ…‹ä¸ä¸€è‡´å°è‡´çš„è³‡æ–™éŒ¯èª¤
- ä½¿ç”¨è€…èª¤åˆªç‡ < 1%

---

## ä½¿ç”¨è€…æ•…äº‹

### Story 1: å»ºç«‹è‡ªå»ºçµ„åˆä¿‚æ•¸
**èº«ä»½**: ç¢³ç®¡ç†äººå“¡
**éœ€æ±‚**: æˆ‘æƒ³è¦å»ºç«‹è‡ªå·±çš„çµ„åˆä¿‚æ•¸
**ç›®çš„**: ç”¨æ–¼è¨ˆç®—ç‰¹å®šæƒ…å¢ƒä¸‹çš„æ’æ”¾é‡

**é©—æ”¶æ¢ä»¶**:
- âœ… å¯ä»¥é¸æ“‡å¤šå€‹åŸºç¤ä¿‚æ•¸ä½œç‚ºçµ„æˆ
- âœ… å¯ä»¥è¨­å®šæ¬Šé‡æˆ–ä½¿ç”¨ç°¡å–®åŠ ç¸½
- âœ… å³æ™‚é¡¯ç¤ºè¨ˆç®—çµæœ
- âœ… å„²å­˜å¾Œé¡¯ç¤ºåœ¨ã€Œè‡ªå»ºä¿‚æ•¸åº«ã€
- âœ… åˆå§‹ç‹€æ…‹ç‚ºã€ŒæœªåŒ¯å…¥ã€

---

### Story 2: åŒ¯å…¥è‡ªå»ºä¿‚æ•¸åˆ°ä¸­å¤®åº«
**èº«ä»½**: ç¢³ç®¡ç†äººå“¡
**éœ€æ±‚**: æˆ‘æƒ³è¦å°‡é©—è­‰éçš„è‡ªå»ºä¿‚æ•¸åˆ†äº«åˆ°ä¸­å¤®åº«
**ç›®çš„**: è®“å…¶ä»–å°ˆæ¡ˆæˆ–åœ˜éšŠæˆå“¡å¯ä»¥ä½¿ç”¨

**é©—æ”¶æ¢ä»¶**:
- âœ… åªæœ‰ã€ŒæœªåŒ¯å…¥ã€æˆ–ã€Œå·²åŒæ­¥ã€çš„ä¿‚æ•¸å¯ä»¥åŒ¯å…¥
- âœ… åŒ¯å…¥æ™‚éœ€å¡«å¯«é¡å¤–è³‡è¨Šï¼ˆé©ç”¨é¡åˆ¥ã€åœ°å€ç­‰ï¼‰
- âœ… åŒ¯å…¥æˆåŠŸå¾Œï¼š
  - è‡ªå»ºä¿‚æ•¸æ¨™è¨˜ç‚ºã€Œå·²åŒ¯å…¥ã€
  - ä¸­å¤®åº«å‡ºç¾æ–°çš„ä¿‚æ•¸å‰¯æœ¬
  - å»ºç«‹è‡ªå»ºä¿‚æ•¸èˆ‡ä¸­å¤®åº«ä¿‚æ•¸çš„é—œè¯
  - è¨˜éŒ„é¦–æ¬¡åŒ¯å…¥æ™‚é–“

---

### Story 3: å¾ä¸­å¤®åº«ç§»é™¤ä¿‚æ•¸
**èº«ä»½**: ç¢³ç®¡ç†äººå“¡
**éœ€æ±‚**: æˆ‘æƒ³è¦å°‡ä¸å†éœ€è¦åˆ†äº«çš„ä¿‚æ•¸å¾ä¸­å¤®åº«ç§»é™¤
**ç›®çš„**: é¿å…å…¶ä»–äººä½¿ç”¨éæ™‚æˆ–ä¸é©ç”¨çš„ä¿‚æ•¸

**é©—æ”¶æ¢ä»¶**:
- âœ… ä¸­å¤®åº«ä¸­çš„æ‰€æœ‰è‡ªå»ºä¿‚æ•¸éƒ½å¯ä»¥ç§»é™¤
- âœ… ç§»é™¤å‰é¡¯ç¤ºå½±éŸ¿ç¯„åœï¼š
  - æ˜¯å¦æœ‰å°ˆæ¡ˆæ­£åœ¨ä½¿ç”¨
  - ä¾†æºè‡ªå»ºä¿‚æ•¸çš„ç‹€æ…‹è®Šæ›´
- âœ… éœ€è¦ç¢ºèªå°è©±æ¡†
- âœ… ç§»é™¤æˆåŠŸå¾Œï¼š
  - ä¿‚æ•¸å¾ä¸­å¤®åº«åˆ—è¡¨æ¶ˆå¤±
  - ä¾†æºè‡ªå»ºä¿‚æ•¸æ¢å¾©ç‚ºã€ŒæœªåŒ¯å…¥ã€ç‹€æ…‹
  - æ¸…é™¤ `imported_to_central` å’Œ `central_library_id` æ¬„ä½
- âœ… é¡¯ç¤ºæˆåŠŸè¨Šæ¯

---

### Story 4: åˆªé™¤è‡ªå»ºä¿‚æ•¸
**èº«ä»½**: ç¢³ç®¡ç†äººå“¡
**éœ€æ±‚**: æˆ‘æƒ³è¦åˆªé™¤ä¸å†éœ€è¦çš„è‡ªå»ºä¿‚æ•¸
**ç›®çš„**: ä¿æŒä¿‚æ•¸åº«çš„æ•´æ½”

**é©—æ”¶æ¢ä»¶**:
- âœ… åªæœ‰ã€ŒæœªåŒ¯å…¥ã€ç‹€æ…‹çš„ä¿‚æ•¸å¯ä»¥ç›´æ¥åˆªé™¤
- âœ… ã€Œå·²åŒ¯å…¥ã€çš„ä¿‚æ•¸éœ€è¦å…ˆå¾ä¸­å¤®åº«ç§»é™¤
- âœ… åˆªé™¤å‰é¡¯ç¤ºé˜»æ“‹æç¤ºï¼ˆå¦‚æœå·²åŒ¯å…¥ï¼‰
- âœ… åˆªé™¤å‰é¡¯ç¤ºå½±éŸ¿ç¯„åœï¼ˆå¦‚æœæœ‰å°ˆæ¡ˆä½¿ç”¨ï¼‰
- âœ… éœ€è¦ç¢ºèªå°è©±æ¡†
- âœ… åˆªé™¤æˆåŠŸå¾Œä¿‚æ•¸æ°¸ä¹…ç§»é™¤

---

## åŠŸèƒ½éœ€æ±‚

### 1. å»ºç«‹è‡ªå»ºä¿‚æ•¸

#### 1.1 å»ºç«‹å…¥å£
- **ä½ç½®**: è‡ªå»ºä¿‚æ•¸åº«é é¢
- **è§¸ç™¼**: é»æ“Šã€Œæ–°å¢çµ„åˆä¿‚æ•¸ã€æŒ‰éˆ•
- **é–‹å•Ÿ**: çµ„åˆä¿‚æ•¸ç·¨è¼¯å™¨ Drawer

#### 1.2 å¿…å¡«æ¬„ä½
| æ¬„ä½ | é¡å‹ | èªªæ˜ | é©—è­‰è¦å‰‡ |
|------|------|------|----------|
| åç¨± | æ–‡å­— | ä¿‚æ•¸åç¨± | å¿…å¡«ï¼Œ1-100 å­—å…ƒ |
| è¨ˆç®—æ–¹å¼ | é¸é … | åŠ æ¬Šå¹³å‡/ç°¡å–®åŠ ç¸½ | å¿…é¸ |
| çµ„æˆä¿‚æ•¸ | åˆ—è¡¨ | è‡³å°‘ 1 å€‹åŸºç¤ä¿‚æ•¸ | å¿…å¡«ï¼Œâ‰¥1 å€‹ |
| æ¬Šé‡ | æ•¸å­— | åŠ æ¬Šå¹³å‡æ™‚ä½¿ç”¨ | ç¸½å’Œ = 1.0 |
| å–®ä½ | æ–‡å­— | è¨ˆç®—çµæœå–®ä½ | è‡ªå‹•é©—è­‰ä¸€è‡´æ€§ |

#### 1.3 å¯é¸æ¬„ä½
- æè¿°èªªæ˜
- å‚™è¨»

#### 1.4 å„²å­˜å¾Œç‹€æ…‹
```typescript
{
  id: number,
  name: string,
  type: 'composite_factor',
  value: number,  // è¨ˆç®—å€¼
  unit: string,
  version: 'v1.0',  // åˆå§‹ç‰ˆæœ¬
  created_at: timestamp,
  imported_to_central: false,  // é—œéµï¼šæœªåŒ¯å…¥
  central_library_id: undefined,
  components: [...],
  formula_type: 'weighted' | 'sum'
}
```

---

### 2. åŒ¯å…¥åˆ°ä¸­å¤®ä¿‚æ•¸åº«

#### 2.1 åŒ¯å…¥æ¢ä»¶
- âœ… ä¿‚æ•¸é¡å‹ = `composite_factor`
- âœ… ç‹€æ…‹ = `imported_to_central: false` æˆ–å·²åŒæ­¥

#### 2.2 åŒ¯å…¥æµç¨‹

**Step 1: é¸æ“‡ä¿‚æ•¸**
- åœ¨è‡ªå»ºä¿‚æ•¸åº«ä¸­é¸æ“‡ç›®æ¨™ä¿‚æ•¸
- é»æ“Šã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€æŒ‰éˆ•

**Step 2: å¡«å¯«ä¸­å¤®åº«è³‡è¨Š**
é–‹å•Ÿå°è©±æ¡†ï¼Œå¡«å¯«ï¼š

| æ¬„ä½ | å¿…å¡« | èªªæ˜ |
|------|------|------|
| GWP æ–¹æ³• | âœ… | AR4/AR5/AR6 |
| é©ç”¨ç”¢å“é¡åˆ¥ | â­• | å¤šé¸ |
| é©ç”¨åœ°å€ | â­• | å¤šé¸ |
| å‚™è¨»èªªæ˜ | â­• | è£œå……èªªæ˜ |

**Step 3: åŸ·è¡ŒåŒ¯å…¥**
```typescript
// 1. åœ¨ä¸­å¤®åº«å»ºç«‹æ–°ä¿‚æ•¸
const centralFactor = {
  id: generateNewId(),  // æ–° IDï¼Œä¸èˆ‡è‡ªå»ºä¿‚æ•¸è¡çª
  ...sourceData,
  type: 'composite_factor',
  source_type: 'user_defined',
  source_composite_id: sourceData.id,  // é—œéµï¼šé—œè¯ä¾†æº
  source_version: sourceData.version,
  synced_at: now(),
  synced_version: sourceData.version,
  imported_at: now(),
  method_gwp: formData.method_gwp,
  applicable_categories: formData.applicable_categories,
  applicable_regions: formData.applicable_regions,
  notes: formData.notes
}

// 2. æ›´æ–°è‡ªå»ºä¿‚æ•¸ç‹€æ…‹
sourceData.imported_to_central = true
sourceData.central_library_id = centralFactor.id
sourceData.imported_at = now()
sourceData.last_synced_at = now()
sourceData.last_synced_version = sourceData.version
```

#### 2.3 UI ç‹€æ…‹è®Šæ›´
- è‡ªå»ºä¿‚æ•¸åº«ï¼šæŒ‰éˆ•è®Šç‚ºã€Œå·²åŒ¯å…¥ä¸­å¤®åº«ã€ï¼ˆç°è‰²ã€ç¦ç”¨ï¼‰
- ä¸­å¤®ä¿‚æ•¸åº«ï¼šæ–°å¢è©²ä¿‚æ•¸ï¼Œæ¨™è¨˜ä¾†æºç‚ºã€Œå¾è‡ªå»ºçµ„åˆä¿‚æ•¸åŒ¯å…¥ã€
- é¡¯ç¤ºæˆåŠŸ Toast: "å·²æˆåŠŸåŒ¯å…¥åˆ°ä¸­å¤®ä¿‚æ•¸åº«"

---

### 3. å¾ä¸­å¤®åº«ç§»é™¤

#### 3.1 ç§»é™¤æ¢ä»¶
- âœ… åœ¨ä¸­å¤®ä¿‚æ•¸åº«é é¢
- âœ… æ‰€æœ‰ä¿‚æ•¸ï¼ˆåŒ…å«æ‰€æœ‰é¡å‹ï¼‰éƒ½å¯ä»¥ç§»é™¤

#### 3.2 ç§»é™¤æµç¨‹

**Step 1: è§¸ç™¼ç§»é™¤**
- é»æ“Šä¿‚æ•¸æŸ¥çœ‹è©³æƒ…
- åœ¨è©³æƒ…é¢æ¿åº•éƒ¨é»æ“Šã€Œå¾ä¸­å¤®ä¿‚æ•¸åº«ç§»é™¤ã€

**Step 2: ç¢ºèªå°è©±æ¡†**

é¡¯ç¤ºå…§å®¹ï¼š
```
ğŸ”´ ç¢ºèªç§»é™¤

æ‚¨ç¢ºå®šè¦å°‡ã€Œ[ä¿‚æ•¸åç¨±]ã€å¾ä¸­å¤®ä¿‚æ•¸åº«ç§»é™¤å—ï¼Ÿ

âš ï¸ ç§»é™¤å½±éŸ¿ï¼š
â€¢ æ­¤ä¿‚æ•¸å°‡å¾ä¸­å¤®ä¿‚æ•¸åº«ä¸­ç§»é™¤
â€¢ ä¾†æºè‡ªå»ºä¿‚æ•¸å°‡æ¢å¾©ç‚ºã€ŒæœªåŒ¯å…¥ã€ç‹€æ…‹

ğŸ“Š ä½¿ç”¨ç‹€æ³ï¼š
â€¢ å°ˆæ¡ˆå¼•ç”¨æ¬¡æ•¸ï¼šX æ¬¡
â€¢ ä½¿ç”¨å°ˆæ¡ˆï¼š[å°ˆæ¡ˆåˆ—è¡¨]

[å–æ¶ˆ] [ç¢ºèªç§»é™¤]
```

**Step 3: åŸ·è¡Œç§»é™¤**

```typescript
// æƒ…æ³ 1: å¾è‡ªå»ºä¿‚æ•¸åŒ¯å…¥çš„çµ„åˆä¿‚æ•¸
if (factor.source_composite_id) {
  // 1. å¾ importedCompositeFactors é™£åˆ—ä¸­ç§»é™¤
  importedCompositeFactors.splice(index, 1)

  // 2. æ›´æ–°ä¾†æºè‡ªå»ºä¿‚æ•¸
  sourceComposite.imported_to_central = false
  sourceComposite.central_library_id = undefined

  console.log('å¾ä¸­å¤®åº«ç§»é™¤çµ„åˆä¿‚æ•¸:', factor.name)
}

// æƒ…æ³ 2: å…¶ä»–é¡å‹ä¿‚æ•¸ï¼ˆæ¨™æº–æ’æ”¾ä¿‚æ•¸ã€ç”¢å“ç¢³è¶³è·¡ç­‰ï¼‰
else {
  // åŠ å…¥ç§»é™¤æ¸…å–®ï¼Œä¸é¡¯ç¤ºåœ¨ä¸­å¤®åº«
  removedFromCentralIds.add(factor.id)

  console.log('å¾ä¸­å¤®åº«ç§»é™¤å…¶ä»–é¡å‹ä¿‚æ•¸:', factor.name)
}
```

**Step 4: UI æ›´æ–°**
- ä¸­å¤®ä¿‚æ•¸åº«ï¼šè©²ä¿‚æ•¸ç«‹å³å¾åˆ—è¡¨æ¶ˆå¤±
- è‡ªå»ºä¿‚æ•¸åº«ï¼šä¾†æºä¿‚æ•¸æŒ‰éˆ•æ¢å¾©ç‚ºã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€ï¼ˆè—è‰²ã€å¯é»æ“Šï¼‰
- è©³æƒ…é¢æ¿ï¼šè‡ªå‹•é—œé–‰
- é¡¯ç¤ºæˆåŠŸ Toast: "å·²æˆåŠŸå¾ä¸­å¤®ä¿‚æ•¸åº«ç§»é™¤"

#### 3.3 é—œéµæŠ€è¡“å¯¦ä½œ

**è³‡æ–™åˆ·æ–°æ©Ÿåˆ¶**ï¼š
```typescript
// page.tsx
const handleRemoveFromCentralConfirm = async () => {
  const result = await removeFromCentral(factorToRemove)

  if (result.success) {
    // 1. é—œé–‰å°è©±æ¡†å’Œé¢æ¿
    setRemoveFromCentralDialogOpen(false)
    setIsDetailPanelOpen(false)
    setSelectedFactor(null)

    // 2. è§¸ç™¼è³‡æ–™åˆ·æ–°
    setRefreshKey(prev => prev + 1)
    setCentralLibraryUpdateKey(prev => prev + 1)
  }
}

// useFactors.ts
useEffect(() => {
  loadFactors()
}, [options.collectionId, options.refreshKey])  // ç›£è½ refreshKey

// è¼‰å…¥è³‡æ–™æ™‚ä½¿ç”¨æ­£ç¢ºçš„å‡½æ•¸
case 'favorites':
  filteredFactors = mockData.getCentralLibraryFactors()  // âœ… æ­£ç¢º
  // filteredFactors = mockData.getFavoriteFactors()  // âŒ éŒ¯èª¤
```

---

### 4. åˆªé™¤è‡ªå»ºä¿‚æ•¸

#### 4.1 åˆªé™¤æ¢ä»¶æª¢æŸ¥

```typescript
// å„ªå…ˆé †åºæª¢æŸ¥
if (factor.imported_to_central) {
  // ğŸš« é˜»æ“‹åˆªé™¤
  return {
    canDelete: false,
    reason: 'factor_in_central_library',
    message: 'æ­¤ä¿‚æ•¸å·²åŒ¯å…¥ä¸­å¤®åº«ï¼Œè«‹å…ˆå¾ä¸­å¤®åº«ç§»é™¤å¾Œå†åˆªé™¤'
  }
}

if (factor.usedInProjects?.length > 0) {
  // âš ï¸ è­¦å‘Šä½†å…è¨±åˆªé™¤
  return {
    canDelete: true,
    warning: true,
    affectedProjects: factor.usedInProjects,
    message: `æ­¤ä¿‚æ•¸æ­£åœ¨ ${factor.usedInProjects.length} å€‹å°ˆæ¡ˆä¸­ä½¿ç”¨`
  }
}

return {
  canDelete: true,
  warning: false
}
```

#### 4.2 åˆªé™¤æµç¨‹

**Case 1: å·²åŒ¯å…¥åˆ°ä¸­å¤®åº« (é˜»æ“‹)**

è§¸ç™¼ã€Œåˆªé™¤ã€â†’ é¡¯ç¤ºé˜»æ“‹å°è©±æ¡†ï¼š

```
ğŸš« ç„¡æ³•åˆªé™¤

æ­¤ä¿‚æ•¸ã€Œ[ä¿‚æ•¸åç¨±]ã€å·²åŒ¯å…¥åˆ°ä¸­å¤®ä¿‚æ•¸åº«ã€‚

è«‹å…ˆåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š
1. å‰å¾€ä¸­å¤®ä¿‚æ•¸åº«
2. æ‰¾åˆ°æ­¤ä¿‚æ•¸
3. é»æ“Šã€Œå¾ä¸­å¤®ä¿‚æ•¸åº«ç§»é™¤ã€
4. å›åˆ°è‡ªå»ºä¿‚æ•¸åº«åŸ·è¡Œåˆªé™¤

[å–æ¶ˆ] [å‰å¾€ä¸­å¤®ä¿‚æ•¸åº«]
```

**Case 2: æœªåŒ¯å…¥ï¼Œç„¡å°ˆæ¡ˆä½¿ç”¨**

è§¸ç™¼ã€Œåˆªé™¤ã€â†’ ç¢ºèªå°è©±æ¡†ï¼š

```
âš ï¸ ç¢ºèªåˆªé™¤

æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ[ä¿‚æ•¸åç¨±]ã€å—ï¼Ÿ

æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚

[å–æ¶ˆ] [ç¢ºèªåˆªé™¤]
```

**Case 3: æœªåŒ¯å…¥ï¼Œæœ‰å°ˆæ¡ˆä½¿ç”¨**

è§¸ç™¼ã€Œåˆªé™¤ã€â†’ è­¦å‘Šå°è©±æ¡†ï¼š

```
âš ï¸ ç¢ºèªåˆªé™¤

æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ[ä¿‚æ•¸åç¨±]ã€å—ï¼Ÿ

ğŸ“Š ä½¿ç”¨ç‹€æ³ï¼š
â€¢ å°ˆæ¡ˆå¼•ç”¨æ¬¡æ•¸ï¼šX æ¬¡
â€¢ ä½¿ç”¨å°ˆæ¡ˆï¼š
  - [å°ˆæ¡ˆ A]
  - [å°ˆæ¡ˆ B]

âš ï¸ åˆªé™¤å¾Œé€™äº›å°ˆæ¡ˆå°‡ç„¡æ³•ä½¿ç”¨æ­¤ä¿‚æ•¸ã€‚
æ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚

[å–æ¶ˆ] [ç¢ºèªåˆªé™¤]
```

#### 4.3 åŸ·è¡Œåˆªé™¤

```typescript
const handleDeleteConfirm = async () => {
  try {
    // 1. å¾é™£åˆ—ä¸­ç§»é™¤
    const index = userDefinedCompositeFactors.findIndex(f => f.id === factorId)
    userDefinedCompositeFactors.splice(index, 1)

    // 2. æ¸…é™¤ç›¸é—œå¼•ç”¨ï¼ˆå¦‚æœæœ‰å°ˆæ¡ˆä½¿ç”¨ï¼‰
    updateProjectReferences(factorId, null)

    // 3. è¨˜éŒ„åˆªé™¤æ—¥èªŒ
    auditLog.create({
      action: 'delete',
      type: 'composite_factor',
      id: factorId,
      name: factor.name,
      deletedBy: currentUser,
      deletedAt: now()
    })

    toast.success('ä¿‚æ•¸å·²åˆªé™¤')
  } catch (error) {
    toast.error('åˆªé™¤å¤±æ•—: ' + error.message)
  }
}
```

---

## ç‹€æ…‹ç®¡ç†

### ä¿‚æ•¸ç‹€æ…‹æµè½‰åœ–

```mermaid
stateDiagram-v2
    [*] --> æœªåŒ¯å…¥: å»ºç«‹è‡ªå»ºä¿‚æ•¸
    æœªåŒ¯å…¥ --> å·²åŒ¯å…¥: åŒ¯å…¥åˆ°ä¸­å¤®åº«
    å·²åŒ¯å…¥ --> æœªåŒ¯å…¥: å¾ä¸­å¤®åº«ç§»é™¤
    æœªåŒ¯å…¥ --> [*]: åˆªé™¤

    note right of å·²åŒ¯å…¥
        ç„¡æ³•ç›´æ¥åˆªé™¤
        å¿…é ˆå…ˆç§»é™¤
    end note

    note right of æœªåŒ¯å…¥
        å¯ä»¥åˆªé™¤
        å¯ä»¥åŒ¯å…¥
    end note
```

### ç‹€æ…‹æ¬„ä½å®šç¾©

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ | å€¼ç¯„åœ |
|---------|------|------|--------|
| `imported_to_central` | boolean | æ˜¯å¦å·²åŒ¯å…¥ä¸­å¤®åº« | true/false |
| `central_library_id` | number? | ä¸­å¤®åº«ä¸­çš„ä¿‚æ•¸ ID | undefined æˆ– ID |
| `imported_at` | string? | é¦–æ¬¡åŒ¯å…¥æ™‚é–“ | ISO 8601 æˆ– undefined |
| `last_synced_at` | string? | æœ€å¾ŒåŒæ­¥æ™‚é–“ | ISO 8601 æˆ– undefined |
| `last_synced_version` | string? | æœ€å¾ŒåŒæ­¥ç‰ˆæœ¬ | v1.0 æˆ– undefined |

### ç‹€æ…‹åˆ¤æ–·é‚è¼¯

```typescript
// åˆ¤æ–·æ˜¯å¦å¯ä»¥åˆªé™¤
function canDeleteFactor(factor: CompositeFactor): boolean {
  return !factor.imported_to_central
}

// åˆ¤æ–·æ˜¯å¦å¯ä»¥åŒ¯å…¥
function canImportFactor(factor: CompositeFactor): boolean {
  return !factor.imported_to_central || isSynced(factor)
}

// åˆ¤æ–·æ˜¯å¦å·²åŒæ­¥
function isSynced(factor: CompositeFactor): boolean {
  return factor.imported_to_central &&
         factor.version === factor.last_synced_version
}
```

---

## ä½¿ç”¨è€…æµç¨‹

### å®Œæ•´ç”Ÿå‘½é€±æœŸç¯„ä¾‹

**æƒ…å¢ƒ**: å¼µä¸‰å»ºç«‹äº†ä¸€å€‹ã€Œè¾¦å…¬å®¤ç”¨é›»çµ„åˆä¿‚æ•¸ã€

#### éšæ®µ 1: å»ºç«‹ (Day 1)
1. å¼µä¸‰é€²å…¥ã€Œè‡ªå»ºä¿‚æ•¸åº«ã€
2. é»æ“Šã€Œæ–°å¢çµ„åˆä¿‚æ•¸ã€
3. é¸æ“‡ 3 å€‹ç”¨é›»ä¿‚æ•¸ä½œç‚ºçµ„æˆ
4. è¨­å®šæ¬Šé‡ä¸¦å„²å­˜
5. **çµæœ**: ä¿‚æ•¸é¡¯ç¤ºåœ¨è‡ªå»ºä¿‚æ•¸åº«ï¼ŒæŒ‰éˆ•ç‚ºã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€

#### éšæ®µ 2: åŒ¯å…¥ (Day 2)
1. å¼µä¸‰é©—è­‰ä¿‚æ•¸æº–ç¢ºæ€§å¾Œæ±ºå®šåˆ†äº«
2. é»æ“Šã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€
3. å¡«å¯«é©ç”¨é¡åˆ¥ã€Œè¾¦å…¬å»ºç¯‰ã€
4. ç¢ºèªåŒ¯å…¥
5. **çµæœ**:
   - è‡ªå»ºä¿‚æ•¸åº«ï¼šæŒ‰éˆ•è®Šç‚ºã€Œå·²åŒ¯å…¥ä¸­å¤®åº«ã€ï¼ˆç°è‰²ï¼‰
   - ä¸­å¤®ä¿‚æ•¸åº«ï¼šå‡ºç¾æ–°çš„ã€Œè¾¦å…¬å®¤ç”¨é›»çµ„åˆä¿‚æ•¸ã€

#### éšæ®µ 3: ç§»é™¤ (Day 30)
1. å¼µä¸‰ç™¼ç¾ä¿‚æ•¸éœ€è¦æ›´æ–°ï¼Œæ±ºå®šå…ˆç§»é™¤
2. é€²å…¥ä¸­å¤®ä¿‚æ•¸åº«
3. æ‰¾åˆ°ã€Œè¾¦å…¬å®¤ç”¨é›»çµ„åˆä¿‚æ•¸ã€
4. é»æ“Šè©³æƒ… â†’ ã€Œå¾ä¸­å¤®ä¿‚æ•¸åº«ç§»é™¤ã€
5. ç¢ºèªç§»é™¤
6. **çµæœ**:
   - ä¸­å¤®ä¿‚æ•¸åº«ï¼šä¿‚æ•¸æ¶ˆå¤±
   - è‡ªå»ºä¿‚æ•¸åº«ï¼šæŒ‰éˆ•æ¢å¾©ç‚ºã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€ï¼ˆè—è‰²ï¼‰

#### éšæ®µ 4: åˆªé™¤ (Day 31)
1. å¼µä¸‰æ±ºå®šä¸å†éœ€è¦æ­¤ä¿‚æ•¸
2. åœ¨è‡ªå»ºä¿‚æ•¸åº«é¸æ“‡è©²ä¿‚æ•¸
3. é»æ“Šã€Œåˆªé™¤ã€
4. ç¢ºèªåˆªé™¤
5. **çµæœ**: ä¿‚æ•¸æ°¸ä¹…ç§»é™¤

---

## UI/UX è¦æ ¼

### æŒ‰éˆ•ç‹€æ…‹è¨­è¨ˆ

#### åŒ¯å…¥æŒ‰éˆ•

| ç‹€æ…‹ | æ–‡å­— | é¡è‰² | æ˜¯å¦å¯é»æ“Š | æ¢ä»¶ |
|------|------|------|-----------|------|
| æœªåŒ¯å…¥ | åŒ¯å…¥åˆ°ä¸­å¤®åº« | è—è‰² (brand) | âœ… | `imported_to_central === false` |
| å·²åŒ¯å…¥ | å·²åŒ¯å…¥ä¸­å¤®åº« | ç°è‰² | âŒ | `imported_to_central === true` |

```tsx
<Button
  colorScheme={factor.imported_to_central ? "gray" : "brand"}
  size="sm"
  w="100%"
  onClick={() => onImportToCentral?.(factor)}
  isDisabled={factor.imported_to_central}
>
  {factor.imported_to_central ? 'å·²åŒ¯å…¥ä¸­å¤®åº«' : 'åŒ¯å…¥åˆ°ä¸­å¤®åº«'}
</Button>
```

#### ç§»é™¤æŒ‰éˆ•

```tsx
{/* åªåœ¨ä¸­å¤®ä¿‚æ•¸åº«ä¸­é¡¯ç¤º */}
{isCentralLibrary && (
  <Button
    colorScheme="red"
    size="sm"
    variant="outline"
    w="100%"
    onClick={() => onRemoveFromCentral?.(factor)}
  >
    å¾ä¸­å¤®ä¿‚æ•¸åº«ç§»é™¤
  </Button>
)}
```

#### åˆªé™¤æŒ‰éˆ•

```tsx
{/* åªåœ¨è‡ªå»ºä¿‚æ•¸åº«ä¸­é¡¯ç¤º */}
{isUserDefined && (
  <Button
    colorScheme="red"
    size="sm"
    variant="outline"
    w="100%"
    onClick={() => handleDelete(factor)}
    isDisabled={factor.imported_to_central}  // é—œéµï¼šå·²åŒ¯å…¥æ™‚ç¦ç”¨
  >
    åˆªé™¤ä¿‚æ•¸
  </Button>
)}
```

### å°è©±æ¡†è¨­è¨ˆè¦ç¯„

#### ç¢ºèªå°è©±æ¡†åŸºæœ¬çµæ§‹
```tsx
<Modal>
  <ModalHeader>
    <Icon /> {title}
  </ModalHeader>

  <ModalBody>
    {/* ä¸»è¦è¨Šæ¯ */}
    <Text>{mainMessage}</Text>

    {/* å½±éŸ¿èªªæ˜å€å¡Š */}
    {impactInfo && (
      <Alert status="warning">
        <AlertIcon />
        <Box>
          <AlertTitle>å½±éŸ¿ç¯„åœ</AlertTitle>
          <AlertDescription>
            {impactInfo}
          </AlertDescription>
        </Box>
      </Alert>
    )}

    {/* ä½¿ç”¨ç‹€æ³ */}
    {usageInfo && (
      <Box mt={4}>
        <Text fontWeight="bold">ä½¿ç”¨ç‹€æ³ï¼š</Text>
        <List>
          {usageInfo.map(item => (
            <ListItem key={item.id}>{item.name}</ListItem>
          ))}
        </List>
      </Box>
    )}
  </ModalBody>

  <ModalFooter>
    <Button variant="ghost" onClick={onCancel}>
      å–æ¶ˆ
    </Button>
    <Button colorScheme={confirmColor} onClick={onConfirm}>
      {confirmText}
    </Button>
  </ModalFooter>
</Modal>
```

### Toast è¨Šæ¯è¦ç¯„

| æ“ä½œ | é¡å‹ | æ¨™é¡Œ | æè¿° | æŒçºŒæ™‚é–“ |
|------|------|------|------|---------|
| åŒ¯å…¥æˆåŠŸ | success | åŒ¯å…¥æˆåŠŸ | ä¿‚æ•¸å·²æˆåŠŸåŒ¯å…¥åˆ°ä¸­å¤®ä¿‚æ•¸åº« | 5s |
| åŒ¯å…¥å¤±æ•— | error | åŒ¯å…¥å¤±æ•— | {éŒ¯èª¤è¨Šæ¯} | 5s |
| ç§»é™¤æˆåŠŸ | success | ç§»é™¤æˆåŠŸ | ä¿‚æ•¸å·²å¾ä¸­å¤®åº«ç§»é™¤ï¼Œè‡ªå»ºä¿‚æ•¸å·²æ¢å¾©ç‚ºæœªåŒ¯å…¥ç‹€æ…‹ | 5s |
| ç§»é™¤å¤±æ•— | error | ç§»é™¤å¤±æ•— | {éŒ¯èª¤è¨Šæ¯} | 5s |
| åˆªé™¤æˆåŠŸ | success | åˆªé™¤æˆåŠŸ | ä¿‚æ•¸å·²åˆªé™¤ | 5s |
| åˆªé™¤å¤±æ•— | error | åˆªé™¤å¤±æ•— | {éŒ¯èª¤è¨Šæ¯} | 5s |

---

## æŠ€è¡“è¦æ ¼

### è³‡æ–™çµæ§‹

#### è‡ªå»ºçµ„åˆä¿‚æ•¸
```typescript
interface UserDefinedCompositeFactor {
  // åŸºæœ¬è³‡è¨Š
  id: number
  name: string
  type: 'composite_factor'
  value: number
  unit: string
  description?: string
  notes?: string

  // çµ„æˆè³‡è¨Š
  formula_type: 'weighted' | 'sum'
  components: CompositeFactorComponent[]

  // ç‰ˆæœ¬è³‡è¨Š
  version: string  // v1.0, v1.1, v2.0
  version_history?: VersionHistoryEntry[]
  created_at: string
  updated_at: string
  created_by: string

  // ä¸­å¤®åº«åŒæ­¥ç‹€æ…‹
  imported_to_central: boolean
  central_library_id?: number
  imported_at?: string
  last_synced_at?: string
  last_synced_version?: string

  // å…¶ä»–
  [key: string]: any
}
```

#### ä¸­å¤®åº«ä¿‚æ•¸ï¼ˆåŒ¯å…¥çš„çµ„åˆä¿‚æ•¸ï¼‰
```typescript
interface CentralLibraryCompositeFactor extends ExtendedFactorTableItem {
  // ç¹¼æ‰¿åŸºæœ¬æ¬„ä½
  id: number  // æ–°çš„ IDï¼Œä¸èˆ‡è‡ªå»ºä¿‚æ•¸è¡çª
  type: 'composite_factor'
  name: string
  value: number
  unit: string

  // ä¸­å¤®åº«ç‰¹æœ‰æ¬„ä½
  source_type: 'user_defined'
  source_composite_id: number  // é—œéµï¼šæŒ‡å‘ä¾†æºè‡ªå»ºä¿‚æ•¸
  source_version: string
  synced_at: string
  synced_version: string
  imported_at: string

  // é¡å¤–è³‡è¨Š
  method_gwp: 'AR4' | 'AR5' | 'AR6'
  applicable_categories?: string[]
  applicable_regions?: string[]
  notes?: string

  // çµ„æˆè³‡è¨Šï¼ˆå‰¯æœ¬ï¼‰
  formula_type: 'weighted' | 'sum'
  components: any[]

  // ä½¿ç”¨è¿½è¹¤
  projectUsage?: any[]
  usageText: string
}
```

### API è¦æ ¼ï¼ˆMock éšæ®µï¼‰

#### 1. å»ºç«‹è‡ªå»ºä¿‚æ•¸
```typescript
function createCompositeFactor(data: CreateCompositeFactorForm): Promise<Response> {
  const newFactor = {
    id: generateId(),
    ...data,
    version: 'v1.0',
    imported_to_central: false,
    created_at: new Date().toISOString()
  }

  userDefinedCompositeFactors.push(newFactor)

  return {
    success: true,
    data: newFactor
  }
}
```

#### 2. åŒ¯å…¥åˆ°ä¸­å¤®åº«
```typescript
function importToCentralLibrary(
  compositeId: number,
  formData: ImportFormData
): Promise<Response> {
  const sourceComposite = getUserDefinedById(compositeId)
  const centralId = generateId()
  const now = new Date().toISOString()

  // å»ºç«‹ä¸­å¤®åº«ä¿‚æ•¸
  const centralFactor = {
    id: centralId,
    ...sourceComposite,
    source_composite_id: compositeId,
    source_version: sourceComposite.version,
    synced_at: now,
    synced_version: sourceComposite.version,
    imported_at: now,
    ...formData
  }

  importedCompositeFactors.push(centralFactor)

  // æ›´æ–°ä¾†æºä¿‚æ•¸
  sourceComposite.imported_to_central = true
  sourceComposite.central_library_id = centralId
  sourceComposite.imported_at = now
  sourceComposite.last_synced_at = now
  sourceComposite.last_synced_version = sourceComposite.version

  return {
    success: true,
    data: { centralId, compositeId }
  }
}
```

#### 3. å¾ä¸­å¤®åº«ç§»é™¤
```typescript
function removeFromCentralLibrary(factor: any): Promise<Response> {
  // æƒ…æ³ 1: å¾è‡ªå»ºä¿‚æ•¸åŒ¯å…¥çš„çµ„åˆä¿‚æ•¸
  if (factor.source_composite_id) {
    const index = importedCompositeFactors.findIndex(f => f.id === factor.id)

    if (index !== -1) {
      const sourceId = factor.source_composite_id

      // ç§»é™¤ä¸­å¤®åº«ä¿‚æ•¸
      importedCompositeFactors.splice(index, 1)

      // æ›´æ–°ä¾†æºä¿‚æ•¸
      const sourceComposite = getUserDefinedById(sourceId)
      sourceComposite.imported_to_central = false
      sourceComposite.central_library_id = undefined

      return { success: true, sourceCompositeId: sourceId }
    }
  }

  // æƒ…æ³ 2: å…¶ä»–é¡å‹ä¿‚æ•¸
  removedFromCentralIds.add(factor.id)
  return { success: true }
}
```

#### 4. åˆªé™¤è‡ªå»ºä¿‚æ•¸
```typescript
function deleteCompositeFactor(factorId: number): Promise<Response> {
  const factor = getUserDefinedById(factorId)

  // æª¢æŸ¥æ˜¯å¦å·²åŒ¯å…¥
  if (factor.imported_to_central) {
    return {
      success: false,
      error: 'FACTOR_IN_CENTRAL_LIBRARY',
      message: 'æ­¤ä¿‚æ•¸å·²åŒ¯å…¥ä¸­å¤®åº«ï¼Œè«‹å…ˆå¾ä¸­å¤®åº«ç§»é™¤'
    }
  }

  // åŸ·è¡Œåˆªé™¤
  const index = userDefinedCompositeFactors.findIndex(f => f.id === factorId)
  userDefinedCompositeFactors.splice(index, 1)

  return { success: true }
}
```

### è³‡æ–™åŒæ­¥æ©Ÿåˆ¶

```typescript
// 1. ä½¿ç”¨ useState ç®¡ç†åˆ·æ–° key
const [refreshKey, setRefreshKey] = useState(0)
const [centralLibraryUpdateKey, setCentralLibraryUpdateKey] = useState(0)

// 2. æ“ä½œå®Œæˆå¾Œè§¸ç™¼åˆ·æ–°
const handleOperationComplete = () => {
  setRefreshKey(prev => prev + 1)
  setCentralLibraryUpdateKey(prev => prev + 1)
}

// 3. useEffect ç›£è½è®ŠåŒ–
useEffect(() => {
  loadFactors()
}, [collectionId, refreshKey])

// 4. ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„è³‡æ–™æº
function getCentralLibraryFactors() {
  // âœ… åŒ…å«åŒ¯å…¥çš„çµ„åˆä¿‚æ•¸
  const importedComposites = getImportedCompositeFactors()

  // âœ… éæ¿¾å·²ç§»é™¤çš„ä¿‚æ•¸
  return allItems.filter(item => !removedFromCentralIds.has(item.id))
}
```

---

## é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶

#### âœ… å»ºç«‹è‡ªå»ºä¿‚æ•¸
- [ ] å¯ä»¥é¸æ“‡ â‰¥1 å€‹åŸºç¤ä¿‚æ•¸
- [ ] åŠ æ¬Šå¹³å‡æ™‚æ¬Šé‡ç¸½å’Œå¿…é ˆ = 1.0
- [ ] å³æ™‚è¨ˆç®—ä¸¦é¡¯ç¤ºçµæœ
- [ ] å„²å­˜å¾Œå‡ºç¾åœ¨è‡ªå»ºä¿‚æ•¸åº«
- [ ] åˆå§‹ç‹€æ…‹ `imported_to_central = false`
- [ ] æŒ‰éˆ•é¡¯ç¤ºã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€ï¼ˆè—è‰²ã€å¯é»æ“Šï¼‰

#### âœ… åŒ¯å…¥åˆ°ä¸­å¤®åº«
- [ ] åªæœ‰æœªåŒ¯å…¥çš„ä¿‚æ•¸å¯ä»¥åŒ¯å…¥
- [ ] åŒ¯å…¥å°è©±æ¡†é¡¯ç¤ºæ‰€æœ‰å¿…å¡«æ¬„ä½
- [ ] åŒ¯å…¥æˆåŠŸå¾Œï¼š
  - [ ] è‡ªå»ºä¿‚æ•¸åº«æŒ‰éˆ•è®Šç‚ºã€Œå·²åŒ¯å…¥ä¸­å¤®åº«ã€ï¼ˆç°è‰²ã€ç¦ç”¨ï¼‰
  - [ ] ä¸­å¤®ä¿‚æ•¸åº«å‡ºç¾è©²ä¿‚æ•¸
  - [ ] ä¸­å¤®åº«ä¿‚æ•¸æ¨™è¨˜ä¾†æº = "å¾è‡ªå»ºçµ„åˆä¿‚æ•¸åŒ¯å…¥"
  - [ ] å»ºç«‹æ­£ç¢ºçš„é—œè¯ (`source_composite_id`)
- [ ] é¡¯ç¤ºæˆåŠŸ Toast

#### âœ… å¾ä¸­å¤®åº«ç§»é™¤
- [ ] æ‰€æœ‰ä¸­å¤®åº«ä¿‚æ•¸éƒ½å¯ç§»é™¤
- [ ] ç§»é™¤å‰é¡¯ç¤ºç¢ºèªå°è©±æ¡†
- [ ] å°è©±æ¡†é¡¯ç¤ºå½±éŸ¿ç¯„åœå’Œä½¿ç”¨ç‹€æ³
- [ ] ç§»é™¤æˆåŠŸå¾Œï¼š
  - [ ] ä¿‚æ•¸å¾ä¸­å¤®åº«åˆ—è¡¨**ç«‹å³æ¶ˆå¤±**
  - [ ] ä¾†æºè‡ªå»ºä¿‚æ•¸æŒ‰éˆ•æ¢å¾©ç‚ºã€ŒåŒ¯å…¥åˆ°ä¸­å¤®åº«ã€
  - [ ] `imported_to_central` æ¢å¾©ç‚º `false`
  - [ ] `central_library_id` æ¸…é™¤
- [ ] é¡¯ç¤ºæˆåŠŸ Toast
- [ ] è©³æƒ…é¢æ¿è‡ªå‹•é—œé–‰

#### âœ… åˆªé™¤è‡ªå»ºä¿‚æ•¸
- [ ] å·²åŒ¯å…¥çš„ä¿‚æ•¸**ç„¡æ³•åˆªé™¤**ï¼Œé¡¯ç¤ºé˜»æ“‹å°è©±æ¡†
- [ ] æœªåŒ¯å…¥çš„ä¿‚æ•¸å¯ä»¥åˆªé™¤
- [ ] åˆªé™¤å‰é¡¯ç¤ºç¢ºèªå°è©±æ¡†
- [ ] å¦‚æœ‰å°ˆæ¡ˆä½¿ç”¨ï¼Œé¡¯ç¤ºè­¦å‘Šå’Œå°ˆæ¡ˆåˆ—è¡¨
- [ ] åˆªé™¤æˆåŠŸå¾Œä¿‚æ•¸æ°¸ä¹…ç§»é™¤
- [ ] é¡¯ç¤ºæˆåŠŸ Toast

### æ•ˆèƒ½é©—æ”¶
- [ ] å»ºç«‹ä¿‚æ•¸ < 1 ç§’
- [ ] åŒ¯å…¥ä¿‚æ•¸ < 2 ç§’
- [ ] ç§»é™¤ä¿‚æ•¸å¾Œåˆ—è¡¨åˆ·æ–° < 500ms
- [ ] åˆªé™¤ä¿‚æ•¸ < 1 ç§’

### è³‡æ–™ä¸€è‡´æ€§é©—æ”¶
- [ ] åŒ¯å…¥å¾Œï¼Œè‡ªå»ºä¿‚æ•¸èˆ‡ä¸­å¤®åº«ä¿‚æ•¸é—œè¯æ­£ç¢º
- [ ] ç§»é™¤å¾Œï¼Œç‹€æ…‹æ¢å¾©å®Œæ•´ç„¡èª¤
- [ ] ä¸åŒç€è¦½å™¨åˆ†é é–“ç‹€æ…‹åŒæ­¥ï¼ˆæœªä¾†ï¼‰
- [ ] ç„¡å­¤å…’è³‡æ–™ï¼ˆç§»é™¤å¾Œä¸­å¤®åº«ä¿‚æ•¸å®Œå…¨æ¸…é™¤ï¼‰

---

## é‚Šç•Œæƒ…æ³è™•ç†

### 1. ä¸¦ç™¼æ“ä½œ
**æƒ…å¢ƒ**: ä½¿ç”¨è€…åŒæ™‚åœ¨å¤šå€‹åˆ†é æ“ä½œåŒä¸€å€‹ä¿‚æ•¸

**è™•ç†æ–¹å¼**:
- Phase 1 (MVP): æœ€å¾Œå¯«å…¥å‹å‡ºï¼Œç„¡é–å®šæ©Ÿåˆ¶
- Phase 2: å¯¦ä½œæ¨‚è§€é–ï¼Œè¡çªæ™‚æç¤ºä½¿ç”¨è€…

### 2. ç¶²è·¯ä¸­æ–·
**æƒ…å¢ƒ**: æ“ä½œéç¨‹ä¸­ç¶²è·¯ä¸­æ–·

**è™•ç†æ–¹å¼**:
- é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
- æ“ä½œå¤±æ•—ï¼Œä¸æ”¹è®Šä»»ä½•ç‹€æ…‹
- ä½¿ç”¨è€…éœ€é‡æ–°æ“ä½œ

### 3. ä¸­å¤®åº«ä¿‚æ•¸è¢«åˆªé™¤ä½†å°ˆæ¡ˆä»åœ¨ä½¿ç”¨
**æƒ…å¢ƒ**: ä¿‚æ•¸å¾ä¸­å¤®åº«ç§»é™¤å¾Œï¼Œæœ‰å°ˆæ¡ˆä»åœ¨å¼•ç”¨

**è™•ç†æ–¹å¼**:
- å…è¨±ç§»é™¤ï¼ˆè»Ÿåˆªé™¤ï¼‰
- å°ˆæ¡ˆä¸­ä¿ç•™ä¿‚æ•¸è³‡æ–™å¿«ç…§
- åœ¨å°ˆæ¡ˆä¸­æ¨™è¨˜ç‚ºã€Œå·²ç§»é™¤ã€ä½†ä»å¯æŸ¥çœ‹

### 4. èª¤åˆªä¿è­·
**æƒ…å¢ƒ**: ä½¿ç”¨è€…ä¸å°å¿ƒé»æ“Šåˆªé™¤

**è™•ç†æ–¹å¼**:
- å¼·åˆ¶é¡¯ç¤ºç¢ºèªå°è©±æ¡†
- æ¸…æ¥šèªªæ˜å½±éŸ¿ç¯„åœ
- æä¾›ã€Œå–æ¶ˆã€æŒ‰éˆ•ï¼Œé è¨­ç„¦é»
- æœªä¾†å¯è€ƒæ…®ã€Œå›æ”¶ç«™ã€æ©Ÿåˆ¶ï¼ˆPhase 2ï¼‰

### 5. å¤§é‡è³‡æ–™æ•ˆèƒ½
**æƒ…å¢ƒ**: ä¸­å¤®åº«æœ‰æ•¸åƒå€‹ä¿‚æ•¸

**è™•ç†æ–¹å¼**:
- ä½¿ç”¨åˆ†é æ©Ÿåˆ¶ï¼ˆ20 ç­†/é ï¼‰
- è™›æ“¬æ»¾å‹•ï¼ˆæœªä¾†å„ªåŒ–ï¼‰
- ä½¿ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è©¢

### 6. ç‰ˆæœ¬è¡çª
**æƒ…å¢ƒ**: è‡ªå»ºä¿‚æ•¸æ›´æ–°ä½†ä¸­å¤®åº«æœªåŒæ­¥

**è™•ç†æ–¹å¼**:
- é¡¯ç¤ºã€ŒæœªåŒæ­¥ã€ç‹€æ…‹
- æä¾›ã€ŒåŒæ­¥ã€æŒ‰éˆ•
- åŒæ­¥æ™‚æ›´æ–°ä¸­å¤®åº«ç‰ˆæœ¬

---

## æœªä¾†è¦åŠƒ (Phase 2)

### 1. æ‰¹æ¬¡æ“ä½œ
- æ‰¹æ¬¡åŒ¯å…¥å¤šå€‹ä¿‚æ•¸
- æ‰¹æ¬¡ç§»é™¤å¤šå€‹ä¿‚æ•¸
- æ‰¹æ¬¡åˆªé™¤å¤šå€‹ä¿‚æ•¸

### 2. æ¬Šé™ç®¡ç†
- åªæœ‰å»ºç«‹è€…å¯ä»¥åˆªé™¤
- ç®¡ç†å“¡å¯ä»¥ç§»é™¤ä»»ä½•ä¸­å¤®åº«ä¿‚æ•¸
- å”¯è®€ä½¿ç”¨è€…åªèƒ½æŸ¥çœ‹

### 3. ç‰ˆæœ¬æ§åˆ¶å¼·åŒ–
- ä¸­å¤®åº«ä¿‚æ•¸è‡ªå‹•åŒæ­¥ä¾†æºæ›´æ–°
- ç‰ˆæœ¬å·®ç•°å°æ¯”
- ç‰ˆæœ¬å›æº¯åŠŸèƒ½

### 4. å¯©è¨ˆæ—¥èªŒ
- è¨˜éŒ„æ‰€æœ‰æ“ä½œæ­·å²
- å¯æŸ¥è©¢èª°åœ¨ä½•æ™‚åšäº†ä»€éº¼
- æ”¯æ´åŒ¯å‡ºå ±è¡¨

### 5. å›æ”¶ç«™æ©Ÿåˆ¶
- åˆªé™¤çš„ä¿‚æ•¸é€²å…¥å›æ”¶ç«™
- 30 å¤©å…§å¯ä»¥æ¢å¾©
- è¶…éæœŸé™è‡ªå‹•æ°¸ä¹…åˆªé™¤

---

## é™„éŒ„

### A. éŒ¯èª¤ä»£ç¢¼è¡¨

| ä»£ç¢¼ | èªªæ˜ | è™•ç†æ–¹å¼ |
|------|------|---------|
| `FACTOR_IN_CENTRAL_LIBRARY` | ä¿‚æ•¸å·²åœ¨ä¸­å¤®åº«ï¼Œç„¡æ³•åˆªé™¤ | æç¤ºå…ˆç§»é™¤ |
| `FACTOR_NOT_FOUND` | æ‰¾ä¸åˆ°ä¿‚æ•¸ | é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ |
| `INVALID_WEIGHT_SUM` | æ¬Šé‡ç¸½å’Œä¸ç‚º 1.0 | æç¤ºä¿®æ­£ |
| `NETWORK_ERROR` | ç¶²è·¯éŒ¯èª¤ | æç¤ºé‡è©¦ |
| `PERMISSION_DENIED` | æ¬Šé™ä¸è¶³ | é¡¯ç¤ºæ¬Šé™éŒ¯èª¤ |

### B. è³‡æ–™åº«æ¬„ä½æ˜ å°„ï¼ˆæœªä¾† API å¯¦ä½œï¼‰

```sql
-- è‡ªå»ºçµ„åˆä¿‚æ•¸è¡¨
CREATE TABLE user_defined_composite_factors (
  id SERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  formula_type VARCHAR(20) NOT NULL,
  value DECIMAL(10, 6) NOT NULL,
  unit VARCHAR(50) NOT NULL,
  version VARCHAR(10) NOT NULL,

  -- ä¸­å¤®åº«åŒæ­¥æ¬„ä½
  imported_to_central BOOLEAN DEFAULT FALSE,
  central_library_id INTEGER,
  imported_at TIMESTAMP,
  last_synced_at TIMESTAMP,
  last_synced_version VARCHAR(10),

  -- å¯©è¨ˆæ¬„ä½
  created_by VARCHAR(100),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP  -- è»Ÿåˆªé™¤
);

-- ä¸­å¤®ä¿‚æ•¸åº«è¡¨
CREATE TABLE central_library_factors (
  id SERIAL PRIMARY KEY,
  type VARCHAR(50) NOT NULL,
  source_type VARCHAR(50) NOT NULL,

  -- ä¾†æºè¿½è¹¤
  source_composite_id INTEGER,  -- FK to user_defined_composite_factors
  source_version VARCHAR(10),
  synced_at TIMESTAMP,
  synced_version VARCHAR(10),

  -- å…¶ä»–æ¬„ä½...
);
```

### C. åƒè€ƒæ–‡ä»¶
- [PRD_Custom_Composite_EFs.md](./PRD_Custom_Composite_EFs.md) - çµ„åˆä¿‚æ•¸ç·¨è¼¯å™¨
- [PRD_Factor_Component_Management.md](./PRD_Factor_Component_Management.md) - ä¿‚æ•¸çµ„æˆç®¡ç†
- [ARCHITECTURE_DIAGRAM.md](./ARCHITECTURE_DIAGRAM.md) - ç³»çµ±æ¶æ§‹åœ–

---

## è®Šæ›´æ­·å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | è®Šæ›´å…§å®¹ |
|------|------|------|---------|
| v1.0 | 2025-11-10 | Product Team | åˆç‰ˆå»ºç«‹ |

